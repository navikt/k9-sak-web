name: Tester
permissions:
  contents: read
  packages: read

on:
  workflow_call:

jobs:
  enhetstester:
    name: Vitest matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        group:
          - fakta
          - prosess
          - behandling
          - v2
          - base
          - øvrig
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjører tester (${{ matrix.group }})
        env:
          # Ensure CI flag is true so vite.config enables thread pool + json reporter
          CI: true
        run: |
          case "${{ matrix.group }}" in
            fakta)
              yarn test --silent "packages/fakta-*/**/*.{spec,test}.{ts,tsx}" --passWithNoTests ;;
            prosess)
              yarn test --silent "packages/prosess-*/**/*.{spec,test}.{ts,tsx}" --passWithNoTests ;;
            behandling)
              yarn test --silent "packages/behandling-*/**/*.{spec,test}.{ts,tsx}" --passWithNoTests ;;
            v2)
              # Vitest plukker automatisk opp .spec/.test filer under katalog, enkel glob holder
              yarn test --silent=true packages/v2 --passWithNoTests ;;
            base)
              yarn test --silent "packages/utils/**/*.{spec,test}.{ts,tsx}" "packages/form/**/*.{spec,test}.{ts,tsx}" "packages/rest-api*/**/*.{spec,test}.{ts,tsx}" "packages/rest-api-hooks/**/*.{spec,test}.{ts,tsx}" --passWithNoTests ;;
            øvrig)
              yarn test --silent "packages/shared-components/**/*.{spec,test}.{ts,tsx}" "packages/modal-sett-pa-vent/**/*.{spec,test}.{ts,tsx}" "packages/sak-app/**/!(app)/**/*.{spec,test}.{ts,tsx}" "packages/ung/**/!(app)/**/*.{spec,test}.{ts,tsx}" --passWithNoTests ;;
          esac
