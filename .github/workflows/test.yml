name: Tester
permissions:
  contents: read
  packages: read

on:
  workflow_call:

jobs:
  prosess-tests:
    name: Vitest prosess shard 1/2
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjør prosess shard 1/2
        env:
          CI: true
        run: |
          yarn test --silent=true --shard=1/2 packages/prosess-* --passWithNoTests

  prosess-tests-2:
    name: Vitest prosess shard 2/2
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjør prosess shard 2/2
        env:
          CI: true
        run: |
          yarn test --silent=true --shard=2/2 packages/prosess-* --passWithNoTests

  other-tests:
    name: Vitest øvrige pakker
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjør øvrige tester
        env:
          CI: true
        run: |
          set -euo pipefail
          # Saml alle kataloger i packages/ unntatt de som starter med prosess-
          DIRS=()
          for d in packages/*; do
            [ -d "$d" ] || continue
            base="$(basename "$d")"
            case "$base" in
              prosess-*) continue ;;
            esac
            DIRS+=("$d")
          done
          echo "Kjører tester i (uten prosess-*): ${DIRS[*]}"
          yarn test --silent=true "${DIRS[@]}" --passWithNoTests
