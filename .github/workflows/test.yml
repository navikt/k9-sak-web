name: Tester
permissions:
  contents: read
  packages: read

on:
  workflow_call:

jobs:
  prosess-tests:
    name: Vitest prosess shard 1/2
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjør prosess shard 1/2
        env:
          CI: true
        run: |
          yarn test --silent=true --shard=1/2 packages/prosess-* --passWithNoTests

  prosess-tests-2:
    name: Vitest prosess shard 2/2
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjør prosess shard 2/2
        env:
          CI: true
        run: |
          yarn test --silent=true --shard=2/2 packages/prosess-* --passWithNoTests

  other-tests-1:
    name: Vitest øvrige pakker shard 1/2
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjør øvrige tester (shard 1/2)
        env:
          CI: true
        run: |
          set -euo pipefail
          DIRS=()
          for d in packages/*; do
            [ -d "$d" ] || continue
            base="$(basename "$d")"
            case "$base" in
              prosess-*) continue ;;
            esac
            DIRS+=("$d")
          done
          IFS=$'\n' SORTED=($(printf '%s\n' "${DIRS[@]}" | sort))
          unset IFS
          echo "Andre pakker (uten prosess-*): ${SORTED[*]}"
          yarn test --silent=true --shard=1/2 "${SORTED[@]}" --passWithNoTests

  other-tests-2:
    name: Vitest øvrige pakker shard 2/2
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v5

      - name: Setup + Install
        uses: ./.github/actions/setup-install
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - name: Kjør øvrige tester (shard 2/2)
        env:
          CI: true
        run: |
          set -euo pipefail
          DIRS=()
          for d in packages/*; do
            [ -d "$d" ] || continue
            base="$(basename "$d")"
            case "$base" in
              prosess-*) continue ;;
            esac
            DIRS+=("$d")
          done
          IFS=$'\n' SORTED=($(printf '%s\n' "${DIRS[@]}" | sort))
          unset IFS
          echo "Andre pakker (uten prosess-*): ${SORTED[*]}"
          yarn test --silent=true --shard=2/2 "${SORTED[@]}" --passWithNoTests
